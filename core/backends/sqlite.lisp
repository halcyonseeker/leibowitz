;; A library backend to store the ontology in an SQLite database.

(in-package :leibowitz-core)

;; Helper macros; these need to be declared before they're called.

(defmacro with-sqlite-tx ((sqlite-library) &body body)
  "Run BODY as an atomic SQLite transaction."
  `(progn
     (sqlite-nq ,sqlite-library "begin transaction")
     (handler-case (progn ,@body)
       (T (c)
         (sqlite-nq ,sqlite-library "rollback")
         (error c))
       (:no-error (c)
         (declare (ignore c))
         (sqlite-nq ,sqlite-library "commit")))))

(defmacro ccat (&rest strings)
  "Concatenate some strings at compile-time.  Used internally to shorten
lines with really long SQL queries."
  (format NIL "窿篝蜷铉螬换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换ㄤ彐沆狍篑扉翦扉怛狎扉怛狎è溻疳翳呼疱矧篝蜷铉疳翳钺礤洪铋翎蜱轰猸疳翳洪铋翩矧ㄥ蝌矧溻疳翳蝈聃轵邃轰镢蹴孱翎糸镱⒃桢疳翳麸翳友涕翦溽翎忉箦ㄨ犷潇呼疱篑扉翦后耢轸瀛栳钿戾轰镢蹴孱翎糸镱⒃桢栳钿戾翳蝻蹒麒殂溽翎忉箦聃弪殄狎磲溴┅ê滹沲礤铘狒轱⒘扉怛狎忉汶孱麸篝矧翳镱麸祜琦轭友涕翦溽翎忉箦┅ㄤ彐礤翳镤轭轸獒扉瀛轭篝犷沐横骠弪è篑扉翦扉怛狎蝈篝轭轸狎珞脲犰祜鳝雉桢颦脲螬ㄤ邈灬蝈ㄩ珙矧轭轸狎珞┅箦翩箪雉鲠祯ц犷潇濠篑扉翦恒镱铄泗箪雉鲠祯т猸疳翳┅磲疸狎灬礅溽翕飑篑扉翦哄邈豸瀛铒瞽聃弪箪雉鲠祯ц犷潇濠翕飑Ж泸遽翦翎忪殒铒屮轶趔т狒岌ч洄翦铒铛祆躅轳蹂豉疱翦铒铛祆р轵翳溽翦糸礤铒铛祆ы镤殒殄洄溽翦糸礤铒铛祆翦蝽螫翦泸遽翦翎忪殒铒屮轶趔翎珞ь犴濮翦铒铛祆躅轳蹂ъ徕屐翦衄с秕铘轭翦珏泸遽翦翎忪殒铒屮轶趔翎邕溽趱磉牾钽糸镱螫翎邕钺礤翦铒铛祆т狒蹴唛洄翦铒铛祆躅轳蹂翎邕钺礤溽趱磉殇镱泔铈扉泗殓铒蝈泸遽翦翎忪殒铒屮轶趔翎邕痱邃殂狒弩ч骠徵翦铒铛祆翳孱翎绉翦铒铛祆躅轳蹂ㄩ骠徵翳孱翎绌镱泔铈扉泗殓铒蝈泸遽翦鲩螋踽翎忪殒铒屮轶趔箦狎汨躞轭骠蟮翦蝽螫ч洄泔铘孱艚т狒岌泸遽翦趄殓珏殒铒屮轶趔轭氵翎邕泔躅徭翦轭箦螋镱翎邕溽趱磉牾钽糸镱忮玳躔溽翦翎珞箦泔躅泔躅麒弪钺礤铄鳟翎邕钺礤孱洧泸遽翦趄殓珏殒铒屮轶趔溴氵翎邕泔躅徭翦溴戾翦镱翎邕溽趱磉牾钽糸镱忮玳躔溽翦翎珞箦泔躅泔躅麒弪钺礤镬洚翎邕钺礤溴戾翦骝镯翎珞麒弪钺礤镬洚翎邕钺礤犷泔躅犷灬忮轶铛祆孱洧泸遽翦趄殓珏殒铒屮轶趔溽翎唛铘镞骠徭翦轭箦螋镱溽翎忮玳轭箦螋轭麸箦狎汨ㄩ洮翦蝽螬鲠祯弩铄鳟殇铄鳟翦蝽螬孱洧泸遽翦趄殓珏殒铒屮轶趔溽翎哝蝻磉骠徭翦溴戾翦镱溽翎忮玳轭箦螋轭麸箦狎汨箦狎汨殇翦蝽螬鲠祯弩ě溴戾翦К镬洚殇镬洚翦蝽螬孱泸遽翦趄殓珏殒铒屮轶趔溽翎啧痄狒暹骠徭翦躔溽翦镱溽翎忮玳轭箦螋轭麸箦狎汨箦狎汨殇翦蝽螬鲠祯弩ě溴戾翦К镬洚殇镬洚翦蝽螬轭箦螋轭麸箦狎汨ㄩ洮翦蝽螬鲠祯弩铄鳟殇铄鳟翦蝽螬孱洧┅换义徜轭犷黩轸轭溽翎ㄤ彐礤翳镤徜洵溽趱è篑扉翦扉怛狎ㄤ溽趱愆篑扉翦铖㈤铙弪轭麸溽翎ㄩ洮豉疱忾螋璎盹溟骈邃翦蝽螬鲠祯弩楷楷楷楷咯ㄤ狒蹴殇洎ㄤ狒蹴腴钿洎ㄤ狒蹴忾螋洎ㄤ狒蹴盹溟骈邃洎ㄤ狒蹴翦蝽洎洎ㄤ彐礤翳镤珏舡溽趱è篑扉翦扉怛狎殇ㄣ桢汶豉疱殇矧篝蜷铉疳翳钺礤┅眭祠轲戾鲠祯瀛忾钿ㄩ腴钿忾螋盹溟骈邃翦蝽螬篑扉翦蝻Ⅲ屐邈骝镯溽翎麒弪殇竣钺礤篝蜷铉殇┅ㄩ殇磲脲轭篝犷沐т狒蹴洪殇弘轭腴钿衡轵翳忾螋喉镤殒殄盹溟骈邃呼弪眢翦蝽螬紊泰┅ㄤ彐礤翳镤溴飙溽趱è篑扉翦扉怛狎溽趱憝矧殇ㄣ桢汶豉疱溽趱憝矧殇矧溽趱篝蜷铉疳翳钺礤┅戾è殇ē铄邃溽趱憝殇溽趱憝矧殇┅鏖翳篑扉翦豇飑祜镳骘翎轭ㄧ弭溽趱憝翎珞殇滹篑扉翦铖ㄣ汜溴戾翦骝镯翎珞麒弪钺礤犷泔躅犷灬忮轶铛祆翎绛钺礤翎绌┅篑扉翦铖溴戾翦骝镯溽翎麒弪殇竣殇篑扉翦铖溴戾翦骝镯翎邕溽趱磉牾钽糸镱麒弪溽趱磉殇竣殇┅┅换义徜轭犷黩轸轭翎珞ㄤ彐礤翳镤徜洵翎è篑扉翦扉怛狎翎绛矧钺礤ㄣ桢汶豉疱翎绛矧钺礤矧翎篝蜷铉┅麒孱篝蜷铉翎绛矧钺礤箦翩翎绛矧钺礤磲脲轭篝犷沐翎侯犴翎绛矧钺礤┅篑扉翦铖㈤铙弪矧殓铒蝈轭麸翎珞钺礤灬忮飕泔躅舂鲠祯弩楷楷咯翎绛钺礤翎绛矧钺礤ㄩ箪雉怙躅漯翎绛矧钺礤ъ徕屐翎绛灬忮翎绛矧钺礤紊泰翎绛泔躅翎绛矧钺礤┅冤ㄤ彐礤翳镤珏舡翎è篑扉翦扉怛狎钺礤ㄣ桢汶豉疱钺礤篝蜷铉眭祠轲戾鲠祯瀛忾钿钺礤灬忮泔躅舂篑扉翦蝻Ⅲ屐邈骝镯翎珞麒弪钺礤竣钺礤ㄩ钺礤磲脲轭篝犷沐翎侯犴钺礤红徕屐灬忮恒秕铘泔躅舂紊泰┅ㄤ彐礤翳镤溴飙翎è篑扉翦扉怛狎翎绛矧钺礤ㄣ桢汶豉疱翎绛矧钺礤矧溽趱篝蜷铉┅戾è钺礤ē铄邃翎绛钺礤翎绛矧钺礤┅鏖翳篑扉翦豇飑篑扉翦铖溴戾翦骝镯翎珞麒弪钺礤竣钺礤篑扉翦铖溴戾翦骝镯翎邕溽趱磉牾钽糸镱麒弪翎邕钺礤竣钺礤篑扉翦铖溴戾翦骝镯翎邕痱邃殂狒弩麒弪殒翎矧翳孱翎竣钺礤钺礤┅┅换义徜轭犷黩轸轭溽趱憝翎蝈灬糸镱箬轲ㄤ彐礤翳镤徜洵溽趱憝翎珞è篑扉翦扉怛狎溽趱憝矧殇翎珞ㄣ桢汶豉疱溽趱憝矧殇矧溽趱疳翳钺礤篝蜷铉┅ㄣ桢汶豉疱翎珞扉篝灬忮祗è徜洵狍箫钺礤殇ㄡ滗翎钺礤篑扉翦铖ㄣ汜㈤铙弪轭麸翎邕溽趱磉牾钽糸镱翎邕钺礤溽趱磉殇鲠祯弩楷咯钺礤殇┅鏖翳篑扉翦豇飑祜镳骘翎轭翎珞骘殇ē铄邃溽趱憝殇溽趱憝矧殇骘钺礤ē铄邃翎绛钺礤翎绌骘蝈聃轵邃翎珞ē汜筱徜瀛滹黝痱邃殂狒瀛趄邋钺礤滹祜镳骘蝈聃轵邃翎忮轭遽汨栳箬脲镦蝈聃轵邃翎珞滹ㄡ滗狍箫蝈聃轵邃翎殇┅┅┅ㄤ彐礤翳镤珏舡溽趱憝翎珞è篑扉翦扉怛狎溽趱憝矧殇ㄣ桢汶豉疱溽趱憝矧殇矧溽趱疳翳钺礤篝蜷铉┅祜镳骘蝻轭篑扉翦蝻黧ㄣ汜Ⅲ屐邈翎珞骝镯翎珞㈤铑弪觑轭翎邕溽趱磉牾钽糸镱镱翎邕钺礤钺礤麒弪溽趱磉殇竣ē铄邃溽趱憝殇溽趱憝矧殇┅泔祆邈ㄤ弩趄蹉趱蜷铉忾钿钺礤灬忮泔躅舂蝻磲脲轭篝犷沐翎侯犴钺礤恒秕铘泔躅红徕屐灬忮飑┅ㄤ彐礤翳镤溴飙溽趱憝翎珞è篑扉翦扉怛狎溽趱憝矧殇翎珞脲ㄣ狍汜溴紊泰ㄣ桢汶豉疱溽趱憝矧殇矧溽趱疳翳钺礤篝蜷铉┅ㄣ桢汶豉疱翎珞扉篝灬忮祗è溴飙狍箫钺礤殇篑扉翦铖ㄣ汜溴戾翦骝镯翎邕溽趱磉牾钽糸镱Ⅶ桢蝈翎邕钺礤犷溽趱磉殇竣钺礤殇篑扉翦铖ㄣ汜溴戾翦骝镯翎珞麒弪钺礤犷泔躅犷灬忮轶铛祆钺礤┅鏖翳篑扉翦豇飑祜镳骘翎轭翎珞骘钺礤ē铄邃翎绛钺礤翎绌骘殇ē铄邃溽趱憝殇溽趱憝矧殇滹ㄤ屐狍箫钺礤殇麒孱汜筱徜祜镳骘蝈忮轭遽汨栳箬脲镦ē汜筱徜瀛滹黝痱邃殂狒瀛趄邋钺礤滹ㄤ屐狍箫蝈殇┅┅┅ㄤ彐礤翳镤珏舡翎绛溽翎è篑扉翦扉怛狎翎绛矧钺礤ㄣ桢汶豉疱翎绛矧钺礤矧篝蜷铉翎绌祜镳骘蝻轭篑扉翦蝻黧ㄣ汜Ⅲ屐邈溽翎骝镯溽翎㈤铑弪觑轭翎邕溽趱磉牾钽糸镱镱溽趱磉殇溽翎殇麒弪翎邕钺礤竣ē铄邃翎绛钺礤翎绛矧钺礤┅泔祆邈ㄤ弩趄蹉趱蜷铉忾钿ㄩ腴钿忾螋盹溟骈邃翦蝽螬蝻磲脲轭篝犷沐т狒蹴洪殇弘轭腴钿衡轵翳忾螋喉镤殒殄盹溟骈邃呼弪眢翦蝽螬┅换义徜轭犷黩轸轭翎栝弪狎汨殄ㄤ彐礤翳镤徜洵翎绛痱邃殂狒è篑扉翦扉怛狎殒翎绛矧钺礤翳孱翎绛矧钺礤ㄣ桢汶豉疱殒翎绛矧钺礤矧翎篝蜷铉┅ㄣ桢汶豉疱翳孱翎绛矧钺礤矧翎篝蜷铉┅戾è殒钺礤ē铄邃翎绛钺礤殒翎绛矧钺礤┅翳孱钺礤ē铄邃翎绛钺礤翳孱翎绛矧钺礤┅鏖翳篑扉翦豇飑躅戾篌ㄧ弭翎殒钺礤ㄡ滗翎磲脲轭篝犷沐翎侯犴殒钺礤┅躅戾篌ㄧ弭翎翳孱钺礤ㄡ滗翎磲脲轭篝犷沐翎侯犴翳孱钺礤┅篑扉翦铖ㄣ汜㈤铙弪矧殓铒蝈轭麸翎邕痱邃殂狒弩ㄩ骠徵翳孱翎绌Ⅵ犰蹂楷咯殒钺礤翳孱钺礤┅┅ㄤ彐礤翳镤珏舡翎绛痱邃殂狒弩è篑扉翦扉怛狎翎绛矧钺礤ㄣ桢汶豉疱翎绛矧钺礤矧翎篝蜷铉┅祜镳骘蝻轭篑扉翦蝻黧ㄣ汜Ⅲ屐邈翎珞骝镯翎珞㈤铑弪觑轭翎邕痱邃殂狒弩镱翳孱翎钺礤麒弪殒翎竣ē铄邃翎绛钺礤翎绛矧钺礤┅泔祆邈ㄤ弩趄蹉趱蜷铉忾钿钺礤灬忮泔躅舂蝻磲脲轭篝犷沐翎侯犴钺礤恒秕铘泔躅红徕屐灬忮飑┅ㄤ彐礤翳镤珏舡翎绛痱邃殂犷潴è篑扉翦扉怛狎翎绛矧钺礤ㄣ桢汶豉疱翎绛矧钺礤矧翎篝蜷铉┅祜镳骘蝻轭篑扉翦蝻黧ㄣ汜Ⅲ屐邈翎珞骝镯翎珞㈤铑弪觑轭翎邕痱邃殂狒弩镱殒翎钺礤麒弪翳孱翎竣ē铄邃翎绛钺礤翎绛矧钺礤┅泔祆邈ㄤ弩趄蹉趱蜷铉忾钿钺礤灬忮泔躅舂蝻磲脲轭篝犷沐翎侯犴钺礤恒秕铘泔躅红徕屐灬忮飑┅ㄤ彐礤翳镤溴飙翎绛痱邃殂狒è篑扉翦扉怛狎殒翎绛矧钺礤翳孱翎绛矧钺礤ㄣ桢汶豉疱殒翎绛矧钺礤矧翎篝蜷铉┅ㄣ桢汶豉疱翳孱翎绛矧钺礤矧翎篝蜷铉┅戾è殒钺礤ē铄邃翎绛钺礤殒翎绛矧钺礤┅翳孱钺礤ē铄邃翎绛钺礤翳孱翎绛矧钺礤┅篑扉翦铖溴戾翦骝镯翎邕痱邃殂狒弩麒弪殒翎犷翳孱翎竣殒钺礤翳孱钺礤┅换渝狎汨轭犷涕篝轭ㄤ彐礤翳镤聃弪è篑扉翦扉怛狎翦蝽鏖翳翎珞鏖翳秕舡翎珞ㄣ桢汶豉疱翦蝽篝蜷铉ㄣ桢汶豉疱鏖翳翎珞扉篝ㄣ桢汶豉疱鏖翳秕舡翎珞扉篝祜镳骘蝻轭篑扉翦蝻黧ㄣ汜Ⅲ屐邈溽翎骝镯箦狎汨㈧彐觑轭溽翎镱溽翎殇箦狎汨殇Ⅶ桢蝈箦狎汨磲翥矧溴怡蜥铍翦蝽螬泔祆邈ㄤ弩趄蹉趱蜷铉忾钿ㄩ腴钿忾螋盹溟骈邃翦蝽螬蝻磲脲轭篝犷沐т狒蹴洪殇弘轭腴钿衡轵翳忾螋喉镤殒殄盹溟骈邃呼弪眢翦蝽螬┅换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换换龄溟糸镱犰湾翳镤ㄤ彐礤翳镤篑扉翦铖è篑扉翦扉怛狎蝈篝狎珞⒁躅铒瞽聃弪镱翳轶溽翎忉箦ㄡ痧禊＇篑扉翦哄邈豸瀛铒瞽聃弪钽镱扉篝箪雉鲠祯ц犷潇濠狎珞┅ㄤ彐礤翳镤篑扉翦蝻è篑扉翦扉怛狎蝈篝狎珞⒁躅聃弪镱翳轶溽翎忉箦翳狒蝈趱蝾箝铉戾蝻鳟ㄡ痧禊＇篑扉翦哄邈豸瀛镱瀛蝻鳝憝钽镱扉篝箪雉鲠祯ц犷潇濠狎珞┅ㄤ彐礤翳镤篑扉翦蝻黧è篑扉翦扉怛狎蝈篝狎珞⒁躅聃弪镱翳轶溽翎忉箦翳狒蝈趱蝾眭祠轲戾蝻黧ㄡ痧禊＇篑扉翦哄邈豸瀛麸扉篝钽镱扉篝箪雉鲠祯ц犷潇濠狎珞┅ㄤ彐躅ャ狍汜溴滹黝痱邃殂狒瀛趄邋扉蝻雉镳糸镱犰翕紊泰⑶轹孱蚁显狍翳蝻雉翎镦翎栝弪狎汨趄狯弪箦滹黝轸犷蝈趱蝾栳箬翎忪镦犰翎珞翳狒箬秕熹忮徜溴洚涉麇孱泔躅翦翎翳狒轶犰蝈徜轭翳翎忪镦翎珞麸徜洮箝眇禊箅轲轸殄泫沆弩轭翳翎栝弪狎汨狎牾篝殓铒蝈洚换抿遽翦翳栳箬翎忪翳骈蝮糸礤翳轶骢钽糸镱轶汜祆邃躅戾篌翕箦翩翕磲脲栳箬翎忪呼弩＇羼踽飑┅换娘蝈沲蝮轹怛遽漪璀骈蝮箦狎汨镦翳珧狃璎箅轲痖铉换麒孱弼弪麇骈钿翎翳狒麽痱弼轱躞禊孱泔躅翦蝈轭矧溴换麸狯镩蝈沲蝮轭轭骈铋翦禊箦翩ㄧ弭栳箬蝻雉翕飑蝻雉祜镳骘翎轭ㄧ弭翎绛痱邃殂狒弩扉蝻雉骘钺礤翎绛钺礤翎绌躅戾篌ㄧ弭栳箬翎绛钺礤翎绌翕飑滹箦翩ㄧ弭栳箬翎绛钺礤翎绌翕飑翎绛钺礤翎绌ē汜筱徜瀛滹黝痱邃殂狒瀛趄邋扉翎绛钺礤翎绌翕飑翕飑